---
title: "TEMPERATURE ARIMAX MODELS - Influenza hospitalization data"
author: "Victor Felix"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document: default
  html_document: default
---

This function utilizes ensembles and single automatic ARIMAX models which have mean temperature as exogenous variables. The function fits on a rolling window of previous 104 weeks for the state under analysis and a rolling windows with the same size with 1 week-lag for the exogenous variables to generate forecasts. It return some metrics that evaluate the performance of the models:target_end_date, abs_error, cases, forecast, 'N_of_models", weighted interval score (WIS), predictive quantiles. The user can choose a  single best automatic ARIMAXs (auto=TRUE), or ensembles of 27 permutations of 0,1,2 pdq's (ES27=TRUE) or 64 permutations of 0,1,2,3 pdq's (ES64=TRUE). The user also chooses the number of weeks ahead for each forecast, and the size of the rolling window which is set as 2 years (104 weeks).


```{r}
knitr::opts_chunk$set(echo = TRUE)
```
!!!!!!!!!!!!!!!!!!!!
LOADING THE PACKAGES
!!!!!!!!!!!!!!!!!!!!
```{r}
library("tidyr")
library("MMWRweek")
library("data.table")
library("caret")
library("purrr")
library("dplyr")
library("tseries")
library("gtools")
library("forecast")
library("scoringutils")
library("covidHubUtils")
library("parallel")
library("future")#https://cran.r-project.org/web/packages/future/vignettes/future-4-issues.html
library("listenv")
library("epitools")
```
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
LOADING DATASET AND FUNCTIONS 
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

```{r}
###########################################
#       LOADING AND CLEANING THE DATASET  #        
###########################################

# Loads the model
source("ES_TEMPERATURE.R", local = TRUE, chdir = TRUE)

# Loads the dataset
my_data = read.csv("treated_influenza_hosp_dataframe_v2.csv")

my_data$target_end_date<-as.Date(my_data$target_end_date) # set the dates as dates

list_of_states <- split(my_data, my_data$state_name)
```

Loading temperature data for 2010_2024 and filtering only the correct dates

```{r}
# ERA5-based temperature dataframe
temperature_data<-read.csv("final_temperature_data_2010_2024.csv")
temperature_data$date<-as.Date(temperature_data$date)

correct_dates <- as.Date(list_of_states$Alabama$target_end_date)

# Filter temperature_data to keep only rows with correct dates
temperature_data <- temperature_data %>%
  filter(date %in% correct_dates)%>% 
  select(-X,-date, -year,-epi_week)

head(temperature_data)
```

AUTO TEMPERATURE WEEK1

```{r}
start_time <- Sys.time()

AUTO_TEMPERATURE_WEEK1_list <- mclapply(list_of_states, ES_TEMPERATURE, auto=TRUE, n_weeks_ahead=1,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
AUTO_TEMPERATURE_WEEK1 <- bind_rows(AUTO_TEMPERATURE_WEEK1_list, .id = "State")
```

AUTO TEMPERATURE WEEK2

```{r}
start_time <- Sys.time()

AUTO_TEMPERATURE_WEEK2_list <- mclapply(list_of_states, ES_TEMPERATURE, auto=TRUE, n_weeks_ahead=2,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
AUTO_TEMPERATURE_WEEK2 <- bind_rows(AUTO_TEMPERATURE_WEEK2_list, .id = "State")
```

AUTO TEMPERATURE WEEK3

```{r}
start_time <- Sys.time()

AUTO_TEMPERATURE_WEEK3_list <- mclapply(list_of_states, ES_TEMPERATURE, auto=TRUE, n_weeks_ahead=3,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
AUTO_TEMPERATURE_WEEK3 <- bind_rows(AUTO_TEMPERATURE_WEEK3_list, .id = "State")
```

AUTO TEMPERATURE WEEK4

```{r}
start_time <- Sys.time()

AUTO_TEMPERATURE_WEEK4_list <- mclapply(list_of_states, ES_TEMPERATURE, auto=TRUE, n_weeks_ahead=4,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
AUTO_TEMPERATURE_WEEK4 <- bind_rows(AUTO_TEMPERATURE_WEEK4_list, .id = "State")
```

```{r}
save.image("TEMPERATURE_MODELS_influenza_hospitalization.Rdata")
```

ES27 TEMPERATURE WEEK1

```{r}
start_time <- Sys.time()

ES27_TEMPERATURE_WEEK1_list <- mclapply(list_of_states, ES_TEMPERATURE, ES27=TRUE, n_weeks_ahead=1,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
ES27_TEMPERATURE_WEEK1 <- bind_rows(ES27_TEMPERATURE_WEEK1_list, .id = "State")
```

ES27 TEMPERATURE WEEK2

```{r}
start_time <- Sys.time()

ES27_TEMPERATURE_WEEK2_list <- mclapply(list_of_states, ES_TEMPERATURE, ES27=TRUE, n_weeks_ahead=2,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
ES27_TEMPERATURE_WEEK2 <- bind_rows(ES27_TEMPERATURE_WEEK2_list, .id = "State")
```

ES27 TEMPERATURE WEEK3

```{r}
start_time <- Sys.time()

ES27_TEMPERATURE_WEEK3_list <- mclapply(list_of_states, ES_TEMPERATURE, ES27=TRUE, n_weeks_ahead=3,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
ES27_TEMPERATURE_WEEK3 <- bind_rows(ES27_TEMPERATURE_WEEK3_list, .id = "State")
```

ES27 TEMPERATURE WEEK4

```{r}
start_time <- Sys.time()

ES27_TEMPERATURE_WEEK4_list <- mclapply(list_of_states, ES_TEMPERATURE, ES27=TRUE, n_weeks_ahead=4,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
ES27_TEMPERATURE_WEEK4 <- bind_rows(ES27_TEMPERATURE_WEEK4_list, .id = "State")
```

```{r}
save.image("TEMPERATURE_MODELS_influenza_hospitalization.Rdata")

```

ES64 TEMPERATURE WEEK1

```{r}
start_time <- Sys.time()

ES64_TEMPERATURE_WEEK1_list <- mclapply(list_of_states, ES_TEMPERATURE, ES64=TRUE, n_weeks_ahead=1,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
ES64_TEMPERATURE_WEEK1 <- bind_rows(ES64_TEMPERATURE_WEEK1_list, .id = "State")
```

ES64 TEMPERATURE WEEK2

```{r}
start_time <- Sys.time()

ES64_TEMPERATURE_WEEK2_list <- mclapply(list_of_states, ES_TEMPERATURE, ES64=TRUE, n_weeks_ahead=2,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
ES64_TEMPERATURE_WEEK2 <- bind_rows(ES64_TEMPERATURE_WEEK2_list, .id = "State")
```

ES64 TEMPERATURE WEEK3

```{r}
start_time <- Sys.time()

ES64_TEMPERATURE_WEEK3_list <- mclapply(list_of_states, ES_TEMPERATURE, ES64=TRUE, n_weeks_ahead=3,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
ES64_TEMPERATURE_WEEK3 <- bind_rows(ES64_TEMPERATURE_WEEK3_list, .id = "State")
```

ES64 TEMPERATURE WEEK4

```{r}
start_time <- Sys.time()

ES64_TEMPERATURE_WEEK4_list <- mclapply(list_of_states, ES_TEMPERATURE, ES64=TRUE, n_weeks_ahead=4,week_lag=1,temperature_data=temperature_data, mc.cores=2)%>%
  setNames(names(list_of_states))

end_time <- Sys.time()
run_time <- end_time - start_time

print(run_time)

# Combine the list of data frames into a single data frame with names as a column
ES64_TEMPERATURE_WEEK4 <- bind_rows(ES64_TEMPERATURE_WEEK4_list, .id = "State")
```

```{r}
save.image("TEMPERATURE_MODELS_influenza_hospitalization.Rdata")
```


